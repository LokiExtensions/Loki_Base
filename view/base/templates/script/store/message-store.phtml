<?php
declare(strict_types=1);

use Magento\Framework\View\Element\Template;

/** @version 1.0.4 */
/** @var Template $block */
?>
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('LokiMessageStore', {
            messages: [],
            init() {
                Alpine.effect(() => {
                    const messageSection = Alpine.store('LokiLocalStorage').get('messages');
                    if (messageSection && messageSection.messages) {
                        this.messages = [...this.messages, ...messageSection.messages];
                        this.reset();
                    }
                });
            },
            getMessages() {
                const cookieMessages = this.getCookieMessages();
                if (cookieMessages.length > 0) {
                    this.messages = [...this.messages, ...cookieMessages];
                    LokiCookies.remove('mage-messages');
                }

                return this.messages;
            },
            getCookieMessages() {
                const cookieMessages = LokiCookies.get('mage-messages') || [];
                if (!cookieMessages instanceof Array) {
                    LokiCookies.remove('mage-messages');
                    return [];
                }

                return cookieMessages;
            },
            addMessage(type, text) {
                this.messages.push({type, text});
            },
            removeMessage(text) {
                this.messages = Object.values(this.messages).filter(message => message.text !== text);
            },
            saveMessage(type, text) {
                const messages = this.getMessagesFromStore();
                messages.push({type, text});
                this.setMessageInStore(messages);
            },
            addErrorMessage(text) {
                this.addMessage('error', text);
            },
            addWarningMessage(text) {
                this.addMessage('warning', text);
            },
            addSuccessMessage(text) {
                this.addMessage('success', text);
            },
            addNoticeMessage(text) {
                this.addMessage('notice', text);
            },
            reset() {
                this.getStore().set('messages', {
                    data_id: this.getStore().getNewSectionLifetime(),
                    messages: []
                });
            },
            getMessagesFromStore() {
                const messagesSection = this.getStore().get('messages');
                return messagesSection && messagesSection.messages ? messagesSection.messages : [];
            },
            setMessageInStore(messages) {
                this.getStore().set('messages', {
                    data_id: this.getStore().getNewSectionLifetime(),
                    messages
                });
            },
            getStore() {
                return Alpine.store('LokiLocalStorage');
            }
        });
    });
</script>
